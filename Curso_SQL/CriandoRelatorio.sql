SELECT X.CPF, X.NOME, X.MES_ANO, X.QUANTIDADE_VENDAS, X.QUANTIDADE_LIMITE,
CASE WHEN (X.QUANTIDADE_LIMITE - X.QUANTIDADE_VENDAS) < 0 THEN 'INVÁLIDA'
ELSE 'VÁLIDA' END AS STATUS_VENDA, (1 - (X.QUANTIDADE_LIMITE/X.QUANTIDADE_VENDAS)) * 100 AS PERCENTUAL
FROM (SELECT NF.CPF, TC.NOME, DATE_FORMAT(NF.DATA_VENDA, '%Y-%m') AS MES_ANO
, SUM(INF.QUANTIDADE) AS QUANTIDADE_VENDAS 
, MAX(TC.VOLUME_DE_COMPRA) AS QUANTIDADE_LIMITE FROM NOTAS_FISCAIS NF
INNER JOIN ITENS_NOTAS_FISCAIS INF
ON NF.NUMERO = INF.NUMERO
INNER JOIN TABELA_DE_CLIENTES TC 
ON TC.CPF = NF.CPF
GROUP BY NF.CPF, TC.NOME, DATE_FORMAT(NF.DATA_VENDA, '%Y-%m')) X
WHERE (X.QUANTIDADE_LIMITE - X.QUANTIDADE_VENDAS) < 0;

CPF         NOME            MES_ANO         QUANTIDADE_LIMITE               LIMITE              PERCENTUAL
2600586709	César Teixeira	2015-01	19692	        22000	            DENTRO DO LIMITE    	-11.720495632744266
9283760794	Edson Meilelles	2015-01	19060	        25000	            DENTRO DO LIMITE    	-31.164742917103872
492472718	Eduardo Jorge	2015-01	17615	        9500	            PASSOU O LIMITE     	46.06869145614533
1471156710	Érica Carvalho	2015-01	24316	        24500	            DENTRO DO LIMITE	    -0.7567034051653154
19290992743	Fernando Cavalcante	2015-01	25366	    20000	            PASSOU O LIMITE	        21.154301032878653
5840119709	Gabriel Araujo	2015-01	23106	        21000	            PASSOU O LIMITE     	9.11451571020514



SELECT VENDA_TAMANHO.SABOR, VENDA_TAMANHO.TAMANHO, VENDA_TAMANHO.ANO, VENDA_TAMANHO.QUANTIDADE,
ROUND((VENDA_TAMANHO.QUANTIDADE/VENDA_TOTAL.QUANTIDADE) * 100, 2) AS PARTICIPACAO FROM 
(SELECT TP.SABOR, TP.TAMANHO, YEAR(NF.DATA_VENDA) AS ANO, SUM(INF.QUANTIDADE) AS QUANTIDADE FROM 
TABELA_DE_PRODUTOS TP 
INNER JOIN ITENS_NOTAS_FISCAIS INF ON TP.CODIGO_DO_PRODUTO = INF.CODIGO_DO_PRODUTO
INNER JOIN NOTAS_FISCAIS NF ON NF.NUMERO = INF.NUMERO
GROUP BY TP.SABOR, YEAR(NF.DATA_VENDA)) AS VENDA_TAMANHO
INNER JOIN 
(SELECT YEAR(NF.DATA_VENDA) AS ANO, SUM(INF.QUANTIDADE) AS QUANTIDADE FROM 
TABELA_DE_PRODUTOS TP 
INNER JOIN ITENS_NOTAS_FISCAIS INF ON TP.CODIGO_DO_PRODUTO = INF.CODIGO_DO_PRODUTO
INNER JOIN NOTAS_FISCAIS NF ON NF.NUMERO = INF.NUMERO
GROUP BY YEAR(NF.DATA_VENDA)) AS VENDA_TOTAL
ON VENDA_TAMANHO.ANO = VENDA_TOTAL.ANO
ORDER BY VENDA_TAMANHO.QUANTIDADE ASC


SABOR               TAMANHHO    ANO     QUANT.  PART.%
Cereja/Maça	        2 Litros	2018	26301	3.11
Laranja 	        2 Litros	2018	26418	3.12
Laranja	            1 Litro	    2018	26518	3.13
Cereja/Maça	        2 Litros	2017	112210	3.14
Açai	            2 Litros	2018	26538	3.14
Açai	            700 ml	    2017	112558	3.15
Maracujá	        1,5 Litros	2018	26646	3.15